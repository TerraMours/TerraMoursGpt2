using Microsoft.EntityFrameworkCore;
using Newtonsoft.Json.Linq;
using Pgvector;
using Pgvector.EntityFrameworkCore;
using Terramours_Gpt_Vector.Commons;
using Terramours_Gpt_Vector.Dto;
using Terramours_Gpt_Vector.Entities;
using Terramours_Gpt_Vector.IService;
using Terramours_Gpt_Vector.Req;
using Terramours_Gpt_Vector.Res.Vector;

namespace Terramours_Gpt_Vector.Service
{
    public class VectorService : IVectorService
    {
        private readonly EFCoreDbContext _dbContext;
        private readonly ILogger<VectorService> _logger;

        public VectorService(EFCoreDbContext dbContext, ILogger<VectorService> logger)
        {
            _dbContext = dbContext;
            _logger = logger;
        }

        public async Task Delete(VectorDeleteReq req)
        {
            var vector = await _dbContext.vectorItems.FirstOrDefaultAsync(m => m.Metadata == req.Filter && (string.IsNullOrEmpty(req.IndexNamespace) || m.Namespace == req.IndexNamespace));
            if (vector == null)
            {
                throw new NullReferenceException("未别找到对应对象");
            }
            vector.UpdateTime = DateTime.UtcNow;
            vector.IsDeleted = true;
            _dbContext.vectorItems.Update(vector);
            await _dbContext.SaveChangesAsync();
        }

        public async Task<VectorQueryRes> Query(VectorQueryReq req)
        {
            if (req.Vector == null)
            {
                throw new NullReferenceException("Vector必传");
            }
            if (req.TopK == 0)
            {
                throw new NullReferenceException("TopK必传");
            }
            var embedding = new Vector(req.Vector);
            var items = await _dbContext.vectorItems
                .Where(m=>m.IsDeleted==false && m.IndexName == req.Index && (req.Namespace == null || m.Namespace == req.Namespace))
            .OrderBy(x => x.Embedding!.L2Distance(embedding))
            .Take((int)req.TopK)
            .ToListAsync();
            
            var scoredVector = new List<ScoredVector>();
            foreach (VectorItem item in items)
            {
                if (item.Embedding != null)
                {
                    scoredVector.Add(new ScoredVector() { Id = item.Id, Score = 0, Values = item.Embedding.ToArray(), SparseValues = item.SparseValues, Metadata = item.Metadata });
                }
            }
            VectorQueryRes res = new VectorQueryRes() { Matches=scoredVector.ToArray(),Namespace=req.Namespace};
            return res;
        }

        public async Task Test()
        {
            //插入
            _dbContext.Add(new VectorItem { IndexName="test", Embedding = new Vector("-0.021612708, -0.014583971, -0.0024136603, 0.00026180895, -0.025916822, -0.009871822, -0.03474881, 0.0066470266, -0.024561092, -0.021915443, 0.0069892495, -0.0028562471, -0.012892599, -0.0020122062, -0.01316901, -0.0113196885, 0.021481084, -0.029562814, 0.015163118, 0.007667115, 0.012063366, -0.0025502206, 0.00742361, -0.025285026, 0.020467578, 0.020033216, 0.0076407897, -0.011036697, 0.04285687, -0.014952519, 0.0033580647, -0.014465509, -0.014662946, -0.016782098, -0.004656209, -0.025640411, -0.012438496, -0.015452691, -0.012175247, 0.003771036, 0.001143486, 0.024376819, 0.005679588, 0.01176063, -0.035038386, 0.016676797, 0.010931397, -0.023073738, -0.0069366, 0.021507408, 0.015860727, 0.0122739645, -0.003104688, -0.024021432, 0.0033794537, -0.018019365, -0.0075618154, 0.0019480395, -0.017914066, -0.011227552, 0.015966026, -0.0016165108, -0.015966026, 0.020349115, -0.011971229, -0.011155158, -0.039487287, 0.00085555785, 0.011201227, 0.008720109, 0.020638688, 0.018953897, 0.018453725, -0.012188409, 0.033906415, -0.008976776, -0.0047121495, 0.006778651, 0.006545018, -0.020638688, 0.024047757, -0.02585101, -0.016874233, 0.010181138, 0.026311696, 0.013201916, 0.004238302, 0.011095927, -0.012886018, -0.0033235133, 0.009575667, 0.01599235, 0.03224795, 0.030247262, -0.0132677285, 0.02492964, -0.006617411, 0.004264627, 0.009121563, -0.017255943, 0.018282613, -0.0018756461, -0.017979877, -0.011076184, -0.050543725, 0.007700021, 0.024284681, 0.008535835, 0.013228241, -0.003132658, -0.03495941, 0.022283992, 0.015650127, -0.041487977, -0.0011665203, -0.02574571, -0.004188943, 0.006331128, -0.0006243927, -0.016176624, 0.01658466, 0.032537524, -0.0015704423, -0.010062677, 0.014899869, -0.010332506, -0.021388946, -0.013011061, 0.011622424, 0.018598512, 0.017585006, 0.00045245848, -0.015084144, 0.015439529, -0.0085884845, 0.0371707, -0.028483495, 0.016926883, -0.022468265, -0.0050642444, 0.004689115, 0.020994075, -0.011431569, -0.0032412482, 0.004692406, 0.012688581, 0.0054295016, 0.0036756082, 0.0024021433, 0.023165874, 0.024850665, -0.01089191, 0.021941768, 0.014175936, 0.0163609, 0.014715595, 0.0048700985, 0.011076184, -0.0014873544, -0.008943871, -0.005455827, -0.013340121, 0.010141651, -0.005100441, 0.016492523, 0.027983323, -0.008595066, 0.012155503, 0.017598167, 0.016518848, -0.008061987, 0.0033251585, -0.015057819, 0.0015342456, 0.004221849, 0.033616845, 0.027825374, 0.010635243, -0.039434638, -0.029220592, -0.031010682, 0.00059313193, 0.01002977, 0.012142341, -0.024218868, 0.016400386, 0.008621391, 0.0004179071, 0.008364723, -0.01870381, 0.035670184, 0.015742265, 0.015149956, -0.00818045, -0.6334814, -0.018401075, -0.003435394, -0.027509477, 0.031774104, 0.024074081, 0.020138515, 0.021612708, -0.0049161674, -0.056387845, -0.0064035216, 0.029273242, 0.013261147, -0.014333885, -0.012550375, -0.015439529, 0.014781407, -0.010766867, 0.011168321, 0.010306181, -0.00823968, 0.008450279, -0.008266006, 0.0012644158, 0.022955276, -0.016676797, 0.007522328, -0.033248294, -0.024218868, 0.0145181585, -0.024482118, 0.019256633, 0.012326615, -0.009838915, 0.052360144, -0.0093716495, -0.042672593, 0.040961478, 0.008318655, 0.008470023, -0.021770658, 0.0030438118, -0.010102164, 0.014439184, 0.0030602647, 0.0040639, 0.018822273, -0.031853076, 0.028325547, -0.0064364276, -0.0032379574, -0.00012535157, 0.0023527842, -0.0019546207, -0.015268417, -8.015714E-05, 0.027720075, -0.03619668, -0.00064866093, -0.01707167, -0.0034386846, 0.0028628283, -0.0051234756, 0.009569086, -0.018953897, 0.010207464, -0.01891441, 0.018308938, 0.020691339, 0.031695127, 0.00011918168, -0.0006046491, -0.0027772724, 0.005337365, 0.0183221, -0.0010595755, 0.04188285, -0.010970884, -0.008042244, 0.024297843, 0.005462408, -0.019506719, -0.01668996, -0.00081977254, 0.007055062, 0.008983358, -0.013925849, -0.019914756, 0.012741231, 0.018256288, 0.012543795, 0.008140963, 0.02362656, -0.000792625, 0.004211977, -0.01219499, -0.02200758, -0.016229276, 0.0043074046, 0.009332162, -0.028220247, -0.0034386846, 0.025206052, 0.0028480205, 0.010010027, 0.010273276, -0.03817104, 0.015373717, 0.029404866, -0.029009992, 0.0057486906, -0.02531135, -0.0050379196, -0.011569775, -0.014149611, -0.028746745, -0.004692406, -0.014070637, 0.00948353, 0.031510856, 0.027088279, 0.005403177, 0.023876647, -0.008641135, -0.013741576, 0.024732204, -0.02703563, -0.014123286, -0.014057474, -0.012537213, 0.0043106955, -0.004652919, 0.011773792, -0.010687892, 0.01745338, -0.0132677285, 0.018203638, -0.00590664, 0.006212666, -0.01420226, -0.004004669, 0.01599235, 0.004866808, -0.012023878, -0.012826787, -0.011668493, 0.007186686, 0.0046726624, 0.0055479635, 0.017914066, -0.027167253, -0.0048273206, -0.009523017, 0.013807388, 0.002232677, 0.006173179, 0.03285342, 0.0013804097, 0.0011805054, 0.0010151523, 0.015215768, -0.0026851355, -0.00818703, 0.0061633075, 0.005166253, -0.008358142, -0.01566329, 0.009200538, -0.020559713, -0.01425491, -0.020493902, 0.029931363, -0.009555924, -0.0008958678, 0.018598512, 0.022942113, -0.003978344, -0.0054591172, -0.0068247193, -0.009319, 0.0018690649, 0.008147543, -0.0033399663, 0.01420226, -0.0003214512, 0.0029747088, 0.01761133, 0.005775016, -0.023902971, 0.022218179, -0.003761164, 0.011747467, -0.016703121, 0.019111848, 0.015755428, -0.007417029, -0.013188753, 0.010056095, 0.025179727, 0.01880911, 0.012287127, 0.0035472745, -0.0040639, -0.004893133, 0.022205018, -0.017190132, -0.007331473, -0.0031145597, 0.03353787, 0.00991789, 0.005067535, -0.046542346, -0.0163609, -0.0048273206, -0.00028237523, 0.033774793, -0.012925505, -0.0078119016, -2.3667308E-06, 0.017111158, 0.008305493, -0.017176969, 0.0071669426, -0.0036821894, -0.010720798, -0.015373717, 0.005218903, 0.04269892, 0.017887741, -0.014320723, -0.03480146, -0.0061962134, -0.010345669, 0.008279168, 0.016900558, -0.026785543, 0.027509477, -0.014676108, 0.029273242, 0.03285342, 0.0063574533, 0.002405434, 0.030905383, -0.0031293675, 0.00075807364, 0.00644959, -0.0017966715, 0.040566605, -0.005574289, 0.026193233, -0.016045, -0.011082765, -0.014083799, -0.011523707, 0.022534078, -0.023455448, -0.014268073, 0.010418062, 0.008700365, 0.029457515, 0.0012454948, 0.03885549, -0.0065614707, 0.0029681276, 0.016703121, 0.0084173735, -0.020572877, -0.01870381, 0.011576356, -0.021836469, -0.013280891, -0.010931397, 0.01907236, 0.005110313, 0.00041070892, -0.013886362, 0.0062357006, -0.020362277, -0.0033991972, -0.0006688159, 0.000551588, -0.03209, -0.01517628, 0.01251747, 0.00067128387, -0.016071325, -0.0129518295, 0.011833023, -0.035406932, 0.007943526, -0.0038664634, 0.017269107, 0.003425522, -0.0028809267, -0.010859003, 0.008792503, 0.009746779, -0.01425491, -0.051728345, 0.00046397562, 0.009569086, -0.0002741487, 0.0039816345, -0.04248832, 0.0151104685, -0.0022145787, -0.03669685, 0.010753704, 0.002704879, -0.0002743544, -0.014070637, 0.013228241, -0.018519538, -0.019309282, -0.02585101, 0.023705535, -0.028483495, -0.007667115, 0.03132658, -0.00807515, -0.013899525, 0.014031149, -0.017966716, 0.009437461, 0.051728345, 0.025429813, 0.015189443, 0.010036352, -0.007653952, 0.0045114225, -0.032116327, -0.017927228, -0.024995452, 0.002639067, -0.011964648, 0.013544139, 0.0045936876, -0.005488733, 0.007213011, 0.0015260191, -0.007272242, -0.014123286, -0.006739164, 0.012813624, -0.027298877, 0.00084897666, 0.008055407, 0.01875646, -0.0073248916, -0.025271863, 0.020125354, 0.018598512, 0.026653918, -0.015242092, 0.007667115, 0.0032856714, 0.008963614, -0.0022507752, -0.028983667, 0.011234133, -0.011339433, 0.029273242, -0.00042325436, -0.00068979355, 0.013353284, 0.024798015, 0.0048470646, -0.005403177, -0.005014885, -0.0031589828, -0.008252843, 0.014702433, 0.0010957723, -0.0038072325, 0.023863483, 0.00850951, -0.049675006, -0.009740197, -0.021665357, 0.023600236, -0.023192199, -0.01576859, 0.007120874, -0.023902971, -0.018927572, -0.02167852, 0.00015393872, -0.0003623781, 0.003961891, -0.0049556545, -0.013846875, -0.025113914, 0.002194835, -0.00028566582, 0.0074433535, 0.0012956766, -0.012958411, 0.0033235133, -0.0033794537, 0.0041922336, 0.029562814, 0.0028052425, 0.011069602, 0.027562127, 0.0063278377, -0.031853076, -0.024547929, -0.003771036, -0.0026374217, 0.029352216, -0.025758874, -0.0163609, -0.0016995986, 0.0071142926, 0.009292675, 0.008094894, -0.0020089156, 0.005722366, -0.017374406, -0.014965681, 0.01197781, -0.008285749, -0.0069958307, 0.013833713, 0.012741231, -0.033564195, -0.015887052, -0.021612708, -0.0043765074, 0.01837475, 0.0023215234, -0.005014885, -0.022823652, -0.012800462, 0.037591897, -0.027351527, 0.0034222314, 0.0016000577, 0.00026160327, 0.02124416, -0.01122097, 0.017650817, -0.021757495, -0.010207464, 0.0069234376, -0.014676108, 0.01436021, 0.0061863414, 0.010477293, -0.011701399, -0.011905417, -0.008516092, 0.002861183, 0.0021175058, 0.020888774, 0.00379407, -0.0048865518, -0.013925849, -0.017176969, -0.0048799706, 0.008864895, 0.030984357, 0.012787299, -0.016005514, -0.021520572, -0.01750603, 0.01733492, -0.00088352803, 0.03456454, -0.025824685, -0.008785921, -0.019230308, 0.028141273, 0.020533388, -0.022534078, -0.02259989, -0.016571498, -0.025627248, 0.014110124, -0.014570809, -0.015452691, -0.02227083, -0.008555579, 0.014478671, 0.04351499, -0.013037385, 0.020493902, -0.020875612, 0.0021553477, 0.001292386, -0.020230653, 0.024626905, -0.032879747, 0.0021586383, 0.014175936, -0.0019743643, -0.0232975, -0.0006704612, -0.002801952, -0.00041461652, 0.005159672, 0.01420226, -0.004287661, -0.042725243, -0.011280201, -0.02032279, 0.00030294154, 0.012688581, -0.005261681, 0.0055084764, 0.038302667, 0.018638, 0.035775483, -0.00058038085, -0.0041033872, -0.016610986, 0.028562471, -0.0027443664, 0.0053735618, -0.00034386845, 0.0095822485, -0.002282036, 0.015044656, 0.022955276, 0.013195335, 0.031853076, 0.016110813, 0.009009683, 0.0073907035, 0.00027990728, -0.036117706, -0.0021092792, 0.012886018, -0.024218868, -0.01371525, -0.017756116, 0.0035900525, -0.033406243, 0.028167598, -0.020296466, -0.023336986, 0.013939012, -0.010299601, 0.00012051849, -0.006209376, 0.0037809077, 0.0276411, 0.00022417262, 0.030326236, 0.04935911, -0.02357391, -0.025403488, -0.04970133, 0.0054262113, -0.0024860539, 0.014676108, 0.048911586, -0.023231687, -0.001011039, -0.0081212185, 0.031932052, -0.0327218, -0.020941425, 0.007706602, 0.017479705, 0.021520572, -0.012471401, -0.016084488, 0.0008958678, 0.023863483, -0.02633802, -0.0100495145, -0.036301978, -0.022126043, -0.0032757996, -0.0040178313, 0.0070089935, -0.00021101019, 0.021283647, -0.018545862, 0.01896706, -0.031010682, -0.011925161, 0.006107367, -0.009200538, 0.033195645, 0.0017867998, 0.0044686445, -0.0096678035, 0.019322446, -0.020414928, -0.003328449, -0.027167253, 0.042198747, -0.015913377, -0.00710113, 0.013939012, 0.023718696, 0.010312763, 0.02503494, 0.0011780374, -0.0011936678, -0.031721454, -0.0077987392, 0.01804569, 0.0006605894, 0.011931742, -0.016597822, -0.01858535, -0.03690745, -0.027061954, -0.0029763542, -0.0038335575, 0.007140618, -0.004244883, 0.007364379, -0.026890842, 0.0079106195, 0.0032264404, -0.0006400231, -0.0024794724, 0.018927572, -0.028193923, 0.01875646, 0.0039026602, 2.737888E-06, -0.011879092, -0.02449528, -0.009016263, -0.028694095, 0.020901937, 0.009101819, -0.018256288, 0.0025288316, -0.0017209876, -0.0058704433, -0.013504652, 0.0044521918, 0.028694095, 0.007739508, -0.0022178693, 0.013846875, -0.055124253, 0.018111503, -0.018137828, 0.022915788, -0.019717319, -0.028878368, 0.023192199, -0.022152368, 0.00856216, -0.0276411, 0.0064792056, -0.010701055, 0.0047055683, 0.010628661, -0.0036065055, -0.019862104, -0.02861512, -0.014399697, 0.0060283924, 0.0074499347, -0.0058177933, -0.0066075395, 0.015242092, 0.017492868, -0.0026818449, -0.004369926, 0.00444561, -0.020467578, -0.015571154, -0.046858247, -0.027219903, -0.008160706, 0.0024021433, 0.013149266, 0.00612382, -0.0071142926, -0.012260802, -0.017585006, -0.012642513, -0.0044324477, -0.02113886, 0.027061954, 0.018716974, 0.006844463, -0.008621391, 0.010681311, -0.007851389, -0.017887741, -0.025021777, -0.0008333463, 0.02866777, -0.016900558, -0.0065055303, 0.023863483, -0.03961891, -0.017097995, 0.03403804, 0.007732927, -0.0023281046, 0.036775827, -0.018743299, -0.0067062574, -0.012234477, -0.031642478, -0.018940736, 0.012958411, 0.02362656, -0.032985047, -0.0034321032, -0.003978344, -0.021125698, -0.011155158, -0.008364723, -0.0028644735, -0.004735184, 0.012063366, -0.012866274, -0.013781063, -0.002509088, -0.0367495, -0.0049062953, -0.0059954864, 0.018980222, 0.0067292918, 0.027720075, -0.01658466, -0.004689115, 0.018927572, -0.03522266, -0.02303425, 0.007792158, 0.0042317207, 0.026245883, -0.023481773, 0.01186593, -0.010483875, -0.019032871, 0.012162084, -0.00617976, -0.033248294, 0.02373186, 0.0066898046, -0.041830197, -0.005462408, -0.0014684334, -0.04741107, -0.008338398, -0.013991661, -0.0024317587, 0.0077460892, -0.012142341, 0.016887397, 0.0040178313, -0.019875268, 0.0027361398, -0.00818045, -0.0025502206, -0.0012816915, 0.25545642, -0.007173524, 0.021889118, 0.018006202, 0.017269107, 0.03548591, 0.024745366, 0.018953897, 0.010707635, 0.020980911, -0.013794226, -0.017242782, -0.010924816, 7.203345E-05, 0.0037480015, -0.029404866, -0.03798677, -0.0048799706, -0.024745366, -0.0232975, -0.0038598822, 0.026377507, 0.007463097, -0.026811868, 0.005847409, -0.018769624, 0.0053077494, -0.009503273, -0.006456171, 0.003045457, -0.02352126, -0.013939012, 0.01100379, 0.012596444, -0.023942458, -0.0050214664, 0.010174558, -0.02698298, 0.035354283, 0.009417717, -0.02628537, -0.011582937, -0.010418062, 0.0074104476, -0.009891565, 0.0066338643, -0.0070024123, -0.028878368, -0.042356696, 0.029826064, -0.007463097, -0.004965526, 0.021533733, 0.040408656, 0.015255255, -0.012886018, 0.046094827, -0.013609951, -0.0009353551, -0.0071142926, -0.005705913, 0.024284681, -0.007614465, 0.009812591, -0.0052682622, 0.011095927, -0.015202605, 0.017835092, 0.013175591, -0.025179727, -0.003968472, 0.005159672, -0.010990628, 6.560648E-05, -0.02800965, -0.01761133, 0.043646615, 0.018190477, 0.0053571085, 0.01479457, -0.014241748, 0.013307216, 0.011589519, -0.028746745, -0.011944904, -0.017479705, 0.02866777, 0.0046595, 0.0017012439, -0.0068049757, 0.0012298644, -0.0022129333, -0.005656554, 0.0023050704, -0.0093716495, 0.030062987, 0.0027953708, 0.008654297, 0.0017621202, -0.0008391048, -0.023007926, 0.023429124, 0.009891565, 0.017229619, -0.02433733, -0.0032330216, 0.008154125, -0.013149266, 0.026785543, -0.03667053, -0.0043106955, -0.006416684, 0.006709548, -0.00823968, -0.015360555, -0.0020072705, 0.010523362, -0.010121908, -0.0019101974, -0.0018394494, 0.022665702, -0.03285342, -0.004909586, 0.02449528, -0.0115960995, -0.017374406, -0.0027608194, -0.018532699, 0.025903659, -0.040013783, 0.022955276, 0.0037150956, 0.043225415, -0.01740073, 0.0042679175, 0.019269796, 0.0068313004, 0.00070418994, -0.015742265, -0.027614776, -0.023389636, 0.010286438, -0.010398319, -0.0092860935, 0.009852078, 0.009226862, 0.042619944, -0.036380954, 0.024363656, -9.080019E-05, -0.031800427, -0.018888086, 3.3445936E-05, -0.009444043, 0.037354972, 0.022047069, -0.04283054, -0.01316901, -0.000720643, 0.028641446, -0.013781063, -0.01555799, 0.033616845, -0.032274276, -0.020928262, 0.029931363, -0.16784729, 0.013504652, 0.013728413, -0.016926883, 0.01799304, -0.0025271864, 0.014807733, 0.008371305, 0.008818828, 0.0099639585, 0.0105365245, -0.0029714182, -0.031668805, 0.010003446, 0.013438839, 0.012010716, -0.02005954, 0.027114604, 0.02943119, 0.0036953518, -0.0042284303, 0.0023807543, -0.03690745, -0.011905417, -0.00056187116, 0.02444263, -0.0049293297, -0.013057129, -0.0019924627, -0.01230029, -0.023600236, -0.0065548895, 0.015057819, 0.00856216, -0.0104312245, 0.0091807945, 0.0004915345, -0.0032955431, -0.019704156, 0.028035974, 0.004409414, 0.032537524, 0.00085720315, 0.013886362, -0.026864517, 0.027614776, 0.031300254, -0.0014215423, -0.0019941078, 0.007094549, 0.00050716486, -0.024745366, 0.016268762, 0.009641479, 0.026798705, 0.012570119, 0.020730825, 0.01647936, 0.0028809267, 0.0054327925, -0.017545518, -0.016492523, 0.010385157, -0.010654986, -0.005251809, 0.0016617567, -0.0029615464, 0.0019431035, -0.0046759527, 0.015057819, 0.0051498003, -0.006005358, -0.00040824094, -0.005343946, -0.004448901, -0.02943119, -0.0012454948, 0.007969851, 0.01609765, 0.015136793, -0.028957343, 0.034485564, -0.026798705, 0.0036295396, 0.0066700606, -0.014491834, 0.030563159, -0.002232677, -0.01658466, -0.008167287, 0.015321068, -0.021586383, 0.0046693715, -0.019480394, -0.007581559, 0.0026867809, 0.003284026, 0.015386879, -0.0076407897, -0.01349149, -0.025837848, -0.009990283, 0.0011122252, 0.018335264, 0.009141306, 0.011964648, 0.004843774, 0.0028184052, 0.040619254, -0.0104509685, -0.019467233, -0.0070682243, 0.012813624, 0.019796293, 0.016163463, 0.022428779, -0.013287472, -0.017295431, 0.014531322, 0.0256799, -0.018677486, -0.020085866, -0.0021388947, 0.015413204, -0.011286783, -0.029826064, -0.03419599, -0.008858315, 0.008502929, 0.016413549, -0.0036328305, 0.03798677, 0.015887052, 0.018453725, -0.005653263, -0.0011986037, 0.013024223, -0.011293364, -0.018150989, 0.027351527, 0.029615466, -0.0058342465, 0.0059033493, -0.02600896, 0.013609951, 0.0098586595, -0.0079106195, -0.01609765, 0.0068378816, -0.023271173, -0.021230998, 0.0015400042, -0.020309627, 0.061758116, 0.010773448, -0.012096272, -0.0027953708, -0.006206085, 0.005765144, -0.0073841223, -0.027272552, -0.012155503, -0.044410035, -0.01837475, 0.034222316, -0.034432914, 0.0061600166, 0.00041893544, 0.0018476759, 0.0007128278, -0.0368548, -0.026272207, -0.0034617188, 0.013057129, 0.005294587, -0.031853076, -0.01761133, -0.027720075, -0.026403831, -0.033722144, 0.014412859, -0.012853112, -0.0029566106, 0.019414583, -0.010181138, 0.0049227485, 0.002969773, 0.0021471211, -0.008437117, 0.008983358, 0.010964303, 0.01778244, -0.016624147, 0.0035012062, 0.01533423, -0.0129518295, -0.0009304192, 0.025824685, -0.008219937, 0.015360555, -0.037486598, -0.024363656, 0.008805665, -0.002184963, 0.02850982, -0.011247295, -0.007087968, -0.025377162, 0.0018361588, -0.0013565528, 0.01609765, -0.0039915065, -0.010944559, -0.005830956, 0.031510856, -0.005771725, 0.005209031, 0.017203294, 0.023692371, -0.020191167, 0.013728413, 0.004564072, 0.00904917, -0.010905072, -0.024798015, 0.03322197, -0.021757495, -0.00829233, -0.09540129, 0.023981946, 0.034222316, 0.00041708446, -0.008200193, -0.014162773, 0.005291296, -0.013346703, 0.008364723, -0.00041893544, -0.016755773, -0.01181328, -0.0078119016, -0.0031984702, -0.030247262, -0.0021158603, 0.020138515, 0.015676452, 0.01750603, 0.010391737, 0.0065910863, -0.0018312229, -0.0019743643, 0.008601647, 0.0044357385, -0.00046726622, 0.00063878915, -0.00033235134, 0.0052254843, 0.015057819, 0.015018331, -0.025482463, -0.0023659465, 0.028878368, -0.013583627, -0.02872042, 0.018624837, 0.0319847, 0.011754049, 0.028536147, -0.0051168944, -0.033090346, 0.0003769802, -0.003787489, -0.014939357, -0.010470713, -0.00520245, 0.014426022, 0.01246482, -0.029799739, -0.004221849, 0.021849632, 0.010911654, 0.0026851355, 0.020783475, -0.0026769089, 0.02232348, 0.011063022, 0.019704156, -0.004356764, 0.013346703, 0.018150989, -0.0031573377, -0.008753015, 0.022889463, 0.024311006, 0.0037052238, 0.0049457825, -0.006541727, -0.019151334, 0.0119119985, -0.0020171423, 0.022205018, 0.031221282, -0.007917201, 0.009944215, 0.013149266, 0.0020845996, -0.022520917, 0.019269796, 0.024455793, -0.008358142, -0.03035256, 0.015873889, 0.012695163, 0.013129523, -0.012471401, -0.013247984, -0.015544828, 0.011971229, -0.015887052, -0.01322166, 0.012550375, 0.00953618, 0.00818045, 0.0132677285, 0.0230869, -0.01018772, -0.0017752826, 0.0162556, 0.008818828, 0.004297533, -0.022257667, -0.0027871444, -0.013583627, 0.032642823, -0.023587072, -0.023850322, 0.0097533595, 0.00016381055, 0.0041856524, 0.0029204139, 0.0014807732, 0.023113225, -0.00030294154, -0.006732582, -0.011346013, 0.0017144063, -0.03782882, 0.025587762, -0.016900558, 0.0120831095, 0.019651506, -0.014426022, 0.006492368, 0.008772759, 0.0011188064, -0.034511887, 0.04541038, -0.0050806976, -0.012227897, 0.014110124, -0.018019365, -0.0070024123, -0.0050971503, 0.021889118, -0.016992696, 0.034643512, -0.018243127, 0.04693722, 0.022797327, -0.028878368, 0.017163808, 0.004564072, -9.830689E-05, 0.007331473, 0.011701399, -0.01967783, 0.008812246, -0.0045936876, -0.02167852, -0.0032988337, -0.025561437, -0.025377162, -0.012747812, 0.0063048033, 0.021941768, -0.040671904, -0.0005951886, 0.03353787, -0.0036723176, -0.009687548, 0.028878368, -0.022626216, -0.002412015, 0.0035538557, 0.023389636, 0.006844463, -0.027325202, -0.0057256566, 0.0020039799, -0.00617976, -0.021336297, 0.021112535, -0.019309282, 0.0011007081, -0.023837158, 0.025811523, -0.0051136035, -0.009641479, 0.023007926, -0.029957687, 0.027614776, 0.023060575, -0.016189788, 0.015044656, 0.012023878, 0.0024366947 "), Metadata = new() { ["input"] = "今天星期三" } });
            _dbContext.SaveChanges();
            //查询
            var embedding = new Vector("-0.021612708, -0.014583971, -0.0024136603, 0.00026180895, -0.025916822, -0.009871822, -0.03474881, 0.0066470266, -0.024561092, -0.021915443, 0.0069892495, -0.0028562471, -0.012892599, -0.0020122062, -0.01316901, -0.0113196885, 0.021481084, -0.029562814, 0.015163118, 0.007667115, 0.012063366, -0.0025502206, 0.00742361, -0.025285026, 0.020467578, 0.020033216, 0.0076407897, -0.011036697, 0.04285687, -0.014952519, 0.0033580647, -0.014465509, -0.014662946, -0.016782098, -0.004656209, -0.025640411, -0.012438496, -0.015452691, -0.012175247, 0.003771036, 0.001143486, 0.024376819, 0.005679588, 0.01176063, -0.035038386, 0.016676797, 0.010931397, -0.023073738, -0.0069366, 0.021507408, 0.015860727, 0.0122739645, -0.003104688, -0.024021432, 0.0033794537, -0.018019365, -0.0075618154, 0.0019480395, -0.017914066, -0.011227552, 0.015966026, -0.0016165108, -0.015966026, 0.020349115, -0.011971229, -0.011155158, -0.039487287, 0.00085555785, 0.011201227, 0.008720109, 0.020638688, 0.018953897, 0.018453725, -0.012188409, 0.033906415, -0.008976776, -0.0047121495, 0.006778651, 0.006545018, -0.020638688, 0.024047757, -0.02585101, -0.016874233, 0.010181138, 0.026311696, 0.013201916, 0.004238302, 0.011095927, -0.012886018, -0.0033235133, 0.009575667, 0.01599235, 0.03224795, 0.030247262, -0.0132677285, 0.02492964, -0.006617411, 0.004264627, 0.009121563, -0.017255943, 0.018282613, -0.0018756461, -0.017979877, -0.011076184, -0.050543725, 0.007700021, 0.024284681, 0.008535835, 0.013228241, -0.003132658, -0.03495941, 0.022283992, 0.015650127, -0.041487977, -0.0011665203, -0.02574571, -0.004188943, 0.006331128, -0.0006243927, -0.016176624, 0.01658466, 0.032537524, -0.0015704423, -0.010062677, 0.014899869, -0.010332506, -0.021388946, -0.013011061, 0.011622424, 0.018598512, 0.017585006, 0.00045245848, -0.015084144, 0.015439529, -0.0085884845, 0.0371707, -0.028483495, 0.016926883, -0.022468265, -0.0050642444, 0.004689115, 0.020994075, -0.011431569, -0.0032412482, 0.004692406, 0.012688581, 0.0054295016, 0.0036756082, 0.0024021433, 0.023165874, 0.024850665, -0.01089191, 0.021941768, 0.014175936, 0.0163609, 0.014715595, 0.0048700985, 0.011076184, -0.0014873544, -0.008943871, -0.005455827, -0.013340121, 0.010141651, -0.005100441, 0.016492523, 0.027983323, -0.008595066, 0.012155503, 0.017598167, 0.016518848, -0.008061987, 0.0033251585, -0.015057819, 0.0015342456, 0.004221849, 0.033616845, 0.027825374, 0.010635243, -0.039434638, -0.029220592, -0.031010682, 0.00059313193, 0.01002977, 0.012142341, -0.024218868, 0.016400386, 0.008621391, 0.0004179071, 0.008364723, -0.01870381, 0.035670184, 0.015742265, 0.015149956, -0.00818045, -0.6334814, -0.018401075, -0.003435394, -0.027509477, 0.031774104, 0.024074081, 0.020138515, 0.021612708, -0.0049161674, -0.056387845, -0.0064035216, 0.029273242, 0.013261147, -0.014333885, -0.012550375, -0.015439529, 0.014781407, -0.010766867, 0.011168321, 0.010306181, -0.00823968, 0.008450279, -0.008266006, 0.0012644158, 0.022955276, -0.016676797, 0.007522328, -0.033248294, -0.024218868, 0.0145181585, -0.024482118, 0.019256633, 0.012326615, -0.009838915, 0.052360144, -0.0093716495, -0.042672593, 0.040961478, 0.008318655, 0.008470023, -0.021770658, 0.0030438118, -0.010102164, 0.014439184, 0.0030602647, 0.0040639, 0.018822273, -0.031853076, 0.028325547, -0.0064364276, -0.0032379574, -0.00012535157, 0.0023527842, -0.0019546207, -0.015268417, -8.015714E-05, 0.027720075, -0.03619668, -0.00064866093, -0.01707167, -0.0034386846, 0.0028628283, -0.0051234756, 0.009569086, -0.018953897, 0.010207464, -0.01891441, 0.018308938, 0.020691339, 0.031695127, 0.00011918168, -0.0006046491, -0.0027772724, 0.005337365, 0.0183221, -0.0010595755, 0.04188285, -0.010970884, -0.008042244, 0.024297843, 0.005462408, -0.019506719, -0.01668996, -0.00081977254, 0.007055062, 0.008983358, -0.013925849, -0.019914756, 0.012741231, 0.018256288, 0.012543795, 0.008140963, 0.02362656, -0.000792625, 0.004211977, -0.01219499, -0.02200758, -0.016229276, 0.0043074046, 0.009332162, -0.028220247, -0.0034386846, 0.025206052, 0.0028480205, 0.010010027, 0.010273276, -0.03817104, 0.015373717, 0.029404866, -0.029009992, 0.0057486906, -0.02531135, -0.0050379196, -0.011569775, -0.014149611, -0.028746745, -0.004692406, -0.014070637, 0.00948353, 0.031510856, 0.027088279, 0.005403177, 0.023876647, -0.008641135, -0.013741576, 0.024732204, -0.02703563, -0.014123286, -0.014057474, -0.012537213, 0.0043106955, -0.004652919, 0.011773792, -0.010687892, 0.01745338, -0.0132677285, 0.018203638, -0.00590664, 0.006212666, -0.01420226, -0.004004669, 0.01599235, 0.004866808, -0.012023878, -0.012826787, -0.011668493, 0.007186686, 0.0046726624, 0.0055479635, 0.017914066, -0.027167253, -0.0048273206, -0.009523017, 0.013807388, 0.002232677, 0.006173179, 0.03285342, 0.0013804097, 0.0011805054, 0.0010151523, 0.015215768, -0.0026851355, -0.00818703, 0.0061633075, 0.005166253, -0.008358142, -0.01566329, 0.009200538, -0.020559713, -0.01425491, -0.020493902, 0.029931363, -0.009555924, -0.0008958678, 0.018598512, 0.022942113, -0.003978344, -0.0054591172, -0.0068247193, -0.009319, 0.0018690649, 0.008147543, -0.0033399663, 0.01420226, -0.0003214512, 0.0029747088, 0.01761133, 0.005775016, -0.023902971, 0.022218179, -0.003761164, 0.011747467, -0.016703121, 0.019111848, 0.015755428, -0.007417029, -0.013188753, 0.010056095, 0.025179727, 0.01880911, 0.012287127, 0.0035472745, -0.0040639, -0.004893133, 0.022205018, -0.017190132, -0.007331473, -0.0031145597, 0.03353787, 0.00991789, 0.005067535, -0.046542346, -0.0163609, -0.0048273206, -0.00028237523, 0.033774793, -0.012925505, -0.0078119016, -2.3667308E-06, 0.017111158, 0.008305493, -0.017176969, 0.0071669426, -0.0036821894, -0.010720798, -0.015373717, 0.005218903, 0.04269892, 0.017887741, -0.014320723, -0.03480146, -0.0061962134, -0.010345669, 0.008279168, 0.016900558, -0.026785543, 0.027509477, -0.014676108, 0.029273242, 0.03285342, 0.0063574533, 0.002405434, 0.030905383, -0.0031293675, 0.00075807364, 0.00644959, -0.0017966715, 0.040566605, -0.005574289, 0.026193233, -0.016045, -0.011082765, -0.014083799, -0.011523707, 0.022534078, -0.023455448, -0.014268073, 0.010418062, 0.008700365, 0.029457515, 0.0012454948, 0.03885549, -0.0065614707, 0.0029681276, 0.016703121, 0.0084173735, -0.020572877, -0.01870381, 0.011576356, -0.021836469, -0.013280891, -0.010931397, 0.01907236, 0.005110313, 0.00041070892, -0.013886362, 0.0062357006, -0.020362277, -0.0033991972, -0.0006688159, 0.000551588, -0.03209, -0.01517628, 0.01251747, 0.00067128387, -0.016071325, -0.0129518295, 0.011833023, -0.035406932, 0.007943526, -0.0038664634, 0.017269107, 0.003425522, -0.0028809267, -0.010859003, 0.008792503, 0.009746779, -0.01425491, -0.051728345, 0.00046397562, 0.009569086, -0.0002741487, 0.0039816345, -0.04248832, 0.0151104685, -0.0022145787, -0.03669685, 0.010753704, 0.002704879, -0.0002743544, -0.014070637, 0.013228241, -0.018519538, -0.019309282, -0.02585101, 0.023705535, -0.028483495, -0.007667115, 0.03132658, -0.00807515, -0.013899525, 0.014031149, -0.017966716, 0.009437461, 0.051728345, 0.025429813, 0.015189443, 0.010036352, -0.007653952, 0.0045114225, -0.032116327, -0.017927228, -0.024995452, 0.002639067, -0.011964648, 0.013544139, 0.0045936876, -0.005488733, 0.007213011, 0.0015260191, -0.007272242, -0.014123286, -0.006739164, 0.012813624, -0.027298877, 0.00084897666, 0.008055407, 0.01875646, -0.0073248916, -0.025271863, 0.020125354, 0.018598512, 0.026653918, -0.015242092, 0.007667115, 0.0032856714, 0.008963614, -0.0022507752, -0.028983667, 0.011234133, -0.011339433, 0.029273242, -0.00042325436, -0.00068979355, 0.013353284, 0.024798015, 0.0048470646, -0.005403177, -0.005014885, -0.0031589828, -0.008252843, 0.014702433, 0.0010957723, -0.0038072325, 0.023863483, 0.00850951, -0.049675006, -0.009740197, -0.021665357, 0.023600236, -0.023192199, -0.01576859, 0.007120874, -0.023902971, -0.018927572, -0.02167852, 0.00015393872, -0.0003623781, 0.003961891, -0.0049556545, -0.013846875, -0.025113914, 0.002194835, -0.00028566582, 0.0074433535, 0.0012956766, -0.012958411, 0.0033235133, -0.0033794537, 0.0041922336, 0.029562814, 0.0028052425, 0.011069602, 0.027562127, 0.0063278377, -0.031853076, -0.024547929, -0.003771036, -0.0026374217, 0.029352216, -0.025758874, -0.0163609, -0.0016995986, 0.0071142926, 0.009292675, 0.008094894, -0.0020089156, 0.005722366, -0.017374406, -0.014965681, 0.01197781, -0.008285749, -0.0069958307, 0.013833713, 0.012741231, -0.033564195, -0.015887052, -0.021612708, -0.0043765074, 0.01837475, 0.0023215234, -0.005014885, -0.022823652, -0.012800462, 0.037591897, -0.027351527, 0.0034222314, 0.0016000577, 0.00026160327, 0.02124416, -0.01122097, 0.017650817, -0.021757495, -0.010207464, 0.0069234376, -0.014676108, 0.01436021, 0.0061863414, 0.010477293, -0.011701399, -0.011905417, -0.008516092, 0.002861183, 0.0021175058, 0.020888774, 0.00379407, -0.0048865518, -0.013925849, -0.017176969, -0.0048799706, 0.008864895, 0.030984357, 0.012787299, -0.016005514, -0.021520572, -0.01750603, 0.01733492, -0.00088352803, 0.03456454, -0.025824685, -0.008785921, -0.019230308, 0.028141273, 0.020533388, -0.022534078, -0.02259989, -0.016571498, -0.025627248, 0.014110124, -0.014570809, -0.015452691, -0.02227083, -0.008555579, 0.014478671, 0.04351499, -0.013037385, 0.020493902, -0.020875612, 0.0021553477, 0.001292386, -0.020230653, 0.024626905, -0.032879747, 0.0021586383, 0.014175936, -0.0019743643, -0.0232975, -0.0006704612, -0.002801952, -0.00041461652, 0.005159672, 0.01420226, -0.004287661, -0.042725243, -0.011280201, -0.02032279, 0.00030294154, 0.012688581, -0.005261681, 0.0055084764, 0.038302667, 0.018638, 0.035775483, -0.00058038085, -0.0041033872, -0.016610986, 0.028562471, -0.0027443664, 0.0053735618, -0.00034386845, 0.0095822485, -0.002282036, 0.015044656, 0.022955276, 0.013195335, 0.031853076, 0.016110813, 0.009009683, 0.0073907035, 0.00027990728, -0.036117706, -0.0021092792, 0.012886018, -0.024218868, -0.01371525, -0.017756116, 0.0035900525, -0.033406243, 0.028167598, -0.020296466, -0.023336986, 0.013939012, -0.010299601, 0.00012051849, -0.006209376, 0.0037809077, 0.0276411, 0.00022417262, 0.030326236, 0.04935911, -0.02357391, -0.025403488, -0.04970133, 0.0054262113, -0.0024860539, 0.014676108, 0.048911586, -0.023231687, -0.001011039, -0.0081212185, 0.031932052, -0.0327218, -0.020941425, 0.007706602, 0.017479705, 0.021520572, -0.012471401, -0.016084488, 0.0008958678, 0.023863483, -0.02633802, -0.0100495145, -0.036301978, -0.022126043, -0.0032757996, -0.0040178313, 0.0070089935, -0.00021101019, 0.021283647, -0.018545862, 0.01896706, -0.031010682, -0.011925161, 0.006107367, -0.009200538, 0.033195645, 0.0017867998, 0.0044686445, -0.0096678035, 0.019322446, -0.020414928, -0.003328449, -0.027167253, 0.042198747, -0.015913377, -0.00710113, 0.013939012, 0.023718696, 0.010312763, 0.02503494, 0.0011780374, -0.0011936678, -0.031721454, -0.0077987392, 0.01804569, 0.0006605894, 0.011931742, -0.016597822, -0.01858535, -0.03690745, -0.027061954, -0.0029763542, -0.0038335575, 0.007140618, -0.004244883, 0.007364379, -0.026890842, 0.0079106195, 0.0032264404, -0.0006400231, -0.0024794724, 0.018927572, -0.028193923, 0.01875646, 0.0039026602, 2.737888E-06, -0.011879092, -0.02449528, -0.009016263, -0.028694095, 0.020901937, 0.009101819, -0.018256288, 0.0025288316, -0.0017209876, -0.0058704433, -0.013504652, 0.0044521918, 0.028694095, 0.007739508, -0.0022178693, 0.013846875, -0.055124253, 0.018111503, -0.018137828, 0.022915788, -0.019717319, -0.028878368, 0.023192199, -0.022152368, 0.00856216, -0.0276411, 0.0064792056, -0.010701055, 0.0047055683, 0.010628661, -0.0036065055, -0.019862104, -0.02861512, -0.014399697, 0.0060283924, 0.0074499347, -0.0058177933, -0.0066075395, 0.015242092, 0.017492868, -0.0026818449, -0.004369926, 0.00444561, -0.020467578, -0.015571154, -0.046858247, -0.027219903, -0.008160706, 0.0024021433, 0.013149266, 0.00612382, -0.0071142926, -0.012260802, -0.017585006, -0.012642513, -0.0044324477, -0.02113886, 0.027061954, 0.018716974, 0.006844463, -0.008621391, 0.010681311, -0.007851389, -0.017887741, -0.025021777, -0.0008333463, 0.02866777, -0.016900558, -0.0065055303, 0.023863483, -0.03961891, -0.017097995, 0.03403804, 0.007732927, -0.0023281046, 0.036775827, -0.018743299, -0.0067062574, -0.012234477, -0.031642478, -0.018940736, 0.012958411, 0.02362656, -0.032985047, -0.0034321032, -0.003978344, -0.021125698, -0.011155158, -0.008364723, -0.0028644735, -0.004735184, 0.012063366, -0.012866274, -0.013781063, -0.002509088, -0.0367495, -0.0049062953, -0.0059954864, 0.018980222, 0.0067292918, 0.027720075, -0.01658466, -0.004689115, 0.018927572, -0.03522266, -0.02303425, 0.007792158, 0.0042317207, 0.026245883, -0.023481773, 0.01186593, -0.010483875, -0.019032871, 0.012162084, -0.00617976, -0.033248294, 0.02373186, 0.0066898046, -0.041830197, -0.005462408, -0.0014684334, -0.04741107, -0.008338398, -0.013991661, -0.0024317587, 0.0077460892, -0.012142341, 0.016887397, 0.0040178313, -0.019875268, 0.0027361398, -0.00818045, -0.0025502206, -0.0012816915, 0.25545642, -0.007173524, 0.021889118, 0.018006202, 0.017269107, 0.03548591, 0.024745366, 0.018953897, 0.010707635, 0.020980911, -0.013794226, -0.017242782, -0.010924816, 7.203345E-05, 0.0037480015, -0.029404866, -0.03798677, -0.0048799706, -0.024745366, -0.0232975, -0.0038598822, 0.026377507, 0.007463097, -0.026811868, 0.005847409, -0.018769624, 0.0053077494, -0.009503273, -0.006456171, 0.003045457, -0.02352126, -0.013939012, 0.01100379, 0.012596444, -0.023942458, -0.0050214664, 0.010174558, -0.02698298, 0.035354283, 0.009417717, -0.02628537, -0.011582937, -0.010418062, 0.0074104476, -0.009891565, 0.0066338643, -0.0070024123, -0.028878368, -0.042356696, 0.029826064, -0.007463097, -0.004965526, 0.021533733, 0.040408656, 0.015255255, -0.012886018, 0.046094827, -0.013609951, -0.0009353551, -0.0071142926, -0.005705913, 0.024284681, -0.007614465, 0.009812591, -0.0052682622, 0.011095927, -0.015202605, 0.017835092, 0.013175591, -0.025179727, -0.003968472, 0.005159672, -0.010990628, 6.560648E-05, -0.02800965, -0.01761133, 0.043646615, 0.018190477, 0.0053571085, 0.01479457, -0.014241748, 0.013307216, 0.011589519, -0.028746745, -0.011944904, -0.017479705, 0.02866777, 0.0046595, 0.0017012439, -0.0068049757, 0.0012298644, -0.0022129333, -0.005656554, 0.0023050704, -0.0093716495, 0.030062987, 0.0027953708, 0.008654297, 0.0017621202, -0.0008391048, -0.023007926, 0.023429124, 0.009891565, 0.017229619, -0.02433733, -0.0032330216, 0.008154125, -0.013149266, 0.026785543, -0.03667053, -0.0043106955, -0.006416684, 0.006709548, -0.00823968, -0.015360555, -0.0020072705, 0.010523362, -0.010121908, -0.0019101974, -0.0018394494, 0.022665702, -0.03285342, -0.004909586, 0.02449528, -0.0115960995, -0.017374406, -0.0027608194, -0.018532699, 0.025903659, -0.040013783, 0.022955276, 0.0037150956, 0.043225415, -0.01740073, 0.0042679175, 0.019269796, 0.0068313004, 0.00070418994, -0.015742265, -0.027614776, -0.023389636, 0.010286438, -0.010398319, -0.0092860935, 0.009852078, 0.009226862, 0.042619944, -0.036380954, 0.024363656, -9.080019E-05, -0.031800427, -0.018888086, 3.3445936E-05, -0.009444043, 0.037354972, 0.022047069, -0.04283054, -0.01316901, -0.000720643, 0.028641446, -0.013781063, -0.01555799, 0.033616845, -0.032274276, -0.020928262, 0.029931363, -0.16784729, 0.013504652, 0.013728413, -0.016926883, 0.01799304, -0.0025271864, 0.014807733, 0.008371305, 0.008818828, 0.0099639585, 0.0105365245, -0.0029714182, -0.031668805, 0.010003446, 0.013438839, 0.012010716, -0.02005954, 0.027114604, 0.02943119, 0.0036953518, -0.0042284303, 0.0023807543, -0.03690745, -0.011905417, -0.00056187116, 0.02444263, -0.0049293297, -0.013057129, -0.0019924627, -0.01230029, -0.023600236, -0.0065548895, 0.015057819, 0.00856216, -0.0104312245, 0.0091807945, 0.0004915345, -0.0032955431, -0.019704156, 0.028035974, 0.004409414, 0.032537524, 0.00085720315, 0.013886362, -0.026864517, 0.027614776, 0.031300254, -0.0014215423, -0.0019941078, 0.007094549, 0.00050716486, -0.024745366, 0.016268762, 0.009641479, 0.026798705, 0.012570119, 0.020730825, 0.01647936, 0.0028809267, 0.0054327925, -0.017545518, -0.016492523, 0.010385157, -0.010654986, -0.005251809, 0.0016617567, -0.0029615464, 0.0019431035, -0.0046759527, 0.015057819, 0.0051498003, -0.006005358, -0.00040824094, -0.005343946, -0.004448901, -0.02943119, -0.0012454948, 0.007969851, 0.01609765, 0.015136793, -0.028957343, 0.034485564, -0.026798705, 0.0036295396, 0.0066700606, -0.014491834, 0.030563159, -0.002232677, -0.01658466, -0.008167287, 0.015321068, -0.021586383, 0.0046693715, -0.019480394, -0.007581559, 0.0026867809, 0.003284026, 0.015386879, -0.0076407897, -0.01349149, -0.025837848, -0.009990283, 0.0011122252, 0.018335264, 0.009141306, 0.011964648, 0.004843774, 0.0028184052, 0.040619254, -0.0104509685, -0.019467233, -0.0070682243, 0.012813624, 0.019796293, 0.016163463, 0.022428779, -0.013287472, -0.017295431, 0.014531322, 0.0256799, -0.018677486, -0.020085866, -0.0021388947, 0.015413204, -0.011286783, -0.029826064, -0.03419599, -0.008858315, 0.008502929, 0.016413549, -0.0036328305, 0.03798677, 0.015887052, 0.018453725, -0.005653263, -0.0011986037, 0.013024223, -0.011293364, -0.018150989, 0.027351527, 0.029615466, -0.0058342465, 0.0059033493, -0.02600896, 0.013609951, 0.0098586595, -0.0079106195, -0.01609765, 0.0068378816, -0.023271173, -0.021230998, 0.0015400042, -0.020309627, 0.061758116, 0.010773448, -0.012096272, -0.0027953708, -0.006206085, 0.005765144, -0.0073841223, -0.027272552, -0.012155503, -0.044410035, -0.01837475, 0.034222316, -0.034432914, 0.0061600166, 0.00041893544, 0.0018476759, 0.0007128278, -0.0368548, -0.026272207, -0.0034617188, 0.013057129, 0.005294587, -0.031853076, -0.01761133, -0.027720075, -0.026403831, -0.033722144, 0.014412859, -0.012853112, -0.0029566106, 0.019414583, -0.010181138, 0.0049227485, 0.002969773, 0.0021471211, -0.008437117, 0.008983358, 0.010964303, 0.01778244, -0.016624147, 0.0035012062, 0.01533423, -0.0129518295, -0.0009304192, 0.025824685, -0.008219937, 0.015360555, -0.037486598, -0.024363656, 0.008805665, -0.002184963, 0.02850982, -0.011247295, -0.007087968, -0.025377162, 0.0018361588, -0.0013565528, 0.01609765, -0.0039915065, -0.010944559, -0.005830956, 0.031510856, -0.005771725, 0.005209031, 0.017203294, 0.023692371, -0.020191167, 0.013728413, 0.004564072, 0.00904917, -0.010905072, -0.024798015, 0.03322197, -0.021757495, -0.00829233, -0.09540129, 0.023981946, 0.034222316, 0.00041708446, -0.008200193, -0.014162773, 0.005291296, -0.013346703, 0.008364723, -0.00041893544, -0.016755773, -0.01181328, -0.0078119016, -0.0031984702, -0.030247262, -0.0021158603, 0.020138515, 0.015676452, 0.01750603, 0.010391737, 0.0065910863, -0.0018312229, -0.0019743643, 0.008601647, 0.0044357385, -0.00046726622, 0.00063878915, -0.00033235134, 0.0052254843, 0.015057819, 0.015018331, -0.025482463, -0.0023659465, 0.028878368, -0.013583627, -0.02872042, 0.018624837, 0.0319847, 0.011754049, 0.028536147, -0.0051168944, -0.033090346, 0.0003769802, -0.003787489, -0.014939357, -0.010470713, -0.00520245, 0.014426022, 0.01246482, -0.029799739, -0.004221849, 0.021849632, 0.010911654, 0.0026851355, 0.020783475, -0.0026769089, 0.02232348, 0.011063022, 0.019704156, -0.004356764, 0.013346703, 0.018150989, -0.0031573377, -0.008753015, 0.022889463, 0.024311006, 0.0037052238, 0.0049457825, -0.006541727, -0.019151334, 0.0119119985, -0.0020171423, 0.022205018, 0.031221282, -0.007917201, 0.009944215, 0.013149266, 0.0020845996, -0.022520917, 0.019269796, 0.024455793, -0.008358142, -0.03035256, 0.015873889, 0.012695163, 0.013129523, -0.012471401, -0.013247984, -0.015544828, 0.011971229, -0.015887052, -0.01322166, 0.012550375, 0.00953618, 0.00818045, 0.0132677285, 0.0230869, -0.01018772, -0.0017752826, 0.0162556, 0.008818828, 0.004297533, -0.022257667, -0.0027871444, -0.013583627, 0.032642823, -0.023587072, -0.023850322, 0.0097533595, 0.00016381055, 0.0041856524, 0.0029204139, 0.0014807732, 0.023113225, -0.00030294154, -0.006732582, -0.011346013, 0.0017144063, -0.03782882, 0.025587762, -0.016900558, 0.0120831095, 0.019651506, -0.014426022, 0.006492368, 0.008772759, 0.0011188064, -0.034511887, 0.04541038, -0.0050806976, -0.012227897, 0.014110124, -0.018019365, -0.0070024123, -0.0050971503, 0.021889118, -0.016992696, 0.034643512, -0.018243127, 0.04693722, 0.022797327, -0.028878368, 0.017163808, 0.004564072, -9.830689E-05, 0.007331473, 0.011701399, -0.01967783, 0.008812246, -0.0045936876, -0.02167852, -0.0032988337, -0.025561437, -0.025377162, -0.012747812, 0.0063048033, 0.021941768, -0.040671904, -0.0005951886, 0.03353787, -0.0036723176, -0.009687548, 0.028878368, -0.022626216, -0.002412015, 0.0035538557, 0.023389636, 0.006844463, -0.027325202, -0.0057256566, 0.0020039799, -0.00617976, -0.021336297, 0.021112535, -0.019309282, 0.0011007081, -0.023837158, 0.025811523, -0.0051136035, -0.009641479, 0.023007926, -0.029957687, 0.027614776, 0.023060575, -0.016189788, 0.015044656, 0.012023878, 0.0024366947 ");
            var items = await _dbContext.vectorItems
            .OrderBy(x => x.Embedding!.L2Distance(embedding))
            .Take(5)
            .ToListAsync();
            foreach (VectorItem item in items)
            {
                if (item.Embedding != null)
                {
                    Console.WriteLine(item.Embedding);
                    Console.WriteLine(item.Metadata);
                }
            }
            throw new NotImplementedException();
        }

        public async Task Update(VectorUpdateReq req)
        {
            if(req.Id == null && req.Values == null)
            {
                throw new NullReferenceException("Id或Values至少一项需有值");
            }
            var item=await _dbContext.vectorItems.Where(m => m.IndexName ==req.Index && (req.Namespace == null || m.Namespace == req.Namespace) && ( (req.Id != null && m.Id ==req.Id) || (req.Values != null && m.Embedding == new Vector(req.Values)))).FirstOrDefaultAsync(); 
            if(item == null)
            {
                throw new NullReferenceException("未找到对象");
            }
            item.SparseValues =req.SparseValues;
            item.Metadata = req.SetMetadata;
            if(req.Id != null) item.Id = req.Id;
            if (req.Values != null) item.Embedding = new Vector(req.Values);
            item.UpdateTime = DateTime.UtcNow;
            _dbContext.Update(item);
            await _dbContext.SaveChangesAsync();
        }

        public async Task<VectorUpsertRes> Upsert(VectorUpsertReq req)
        {
            if(req.Vectors.Count() == 0)
            {
                throw new NotImplementedException("缺少向量数据");
            }
            foreach (var item in req.Vectors)
            {
                VectorItem vector = new VectorItem()
                {
                    Id = item.Id,
                    Embedding = new Vector(item.Values),
                    //SparseValues = item.SparseValues,
                    Metadata = item.Metadata,
                    Namespace = req.Namespace,
                    IndexName = req.Index,
                    CreateTime = DateTime.UtcNow,
                    IsDeleted = false
                };
                await _dbContext.AddAsync(vector);
            }
            await _dbContext.SaveChangesAsync();
            var res= new VectorUpsertRes() { UpsertedCount = Convert.ToUInt32(req.Vectors.Count()) };
            return res;
        }
    }
}
